# MMD模块 - 纹理文件支持指南

## 概述

PMX模型文件本身只包含几何体和材质定义，而纹理图片需要单独提供。本指南介绍如何为PMX模型添加纹理文件支持。

## 纹理文件说明

### PMX模型的纹理结构

PMX模型的材质系统包括：
- **材质定义**: 颜色、透明度、光照属性
- **纹理引用**: 纹理文件的路径（相对路径）
- **UV映射**: 顶点到纹理坐标的映射

### 支持的纹理格式

- **PNG** (推荐) - 支持透明通道
- **JPG/JPEG** - 常用格式，文件较小
- **BMP** - Windows位图格式
- **TGA** - 支持Alpha通道
- **DDS** - DirectX纹理格式

## 使用方法

### 1. 导入PMX模型

1. 打开MMD查看器
2. 点击"导入模型"按钮
3. 选择你的 `.pmx` 文件

### 2. 添加纹理文件

在导入弹窗的"纹理文件"区域：

1. **点击上传区域** 或 **拖拽文件** 到上传区域
2. 选择多个纹理图片文件
3. 查看已选择的纹理文件列表
4. 如需要，点击"清除全部"重新选择

### 3. 查看效果

- 模型将自动应用匹配的纹理
- 控制台会显示纹理映射日志
- 左上角显示纹理统计信息

## 纹理映射原理

### 自动匹配机制

系统会自动将纹理文件与PMX中的引用进行匹配：

1. **精确匹配**: 文件名完全相同
2. **路径忽略**: 忽略PMX中的路径部分，只匹配文件名
3. **模糊匹配**: 忽略扩展名进行匹配
4. **大小写忽略**: 不区分大小写

### 匹配示例

```
PMX中的引用          →  匹配的文件名
"textures/face.png"  →  face.png
"../skin.jpg"        →  skin.jpg, skin.png
"Hair.bmp"           →  hair.bmp, Hair.BMP
```

## 技术实现

### 纹理管理器

```typescript
class TextureManager {
  // 添加纹理文件
  addTexture(file: File): void
  
  // 根据路径获取纹理URL
  getTextureUrl(texturePath: string): string | null
  
  // 清理所有纹理
  clear(): void
}
```

### 材质构建流程

```
PMX材质定义 → 检查纹理引用 → 匹配本地文件 → 创建Three.js材质 → 应用到模型
```

### 关键代码

```typescript
// 创建材质时应用纹理
if (material.texture && textureManager) {
  const textureUrl = textureManager.getTextureUrl(material.texture);
  if (textureUrl) {
    const texture = textureLoader.load(textureUrl);
    threeMaterial.map = texture;
  }
}
```

## 优化建议

### 1. 纹理文件准备

- **文件命名**: 使用简单的英文文件名
- **文件大小**: 建议单个纹理不超过2MB
- **分辨率**: 推荐2的幂次方尺寸（512x512, 1024x1024等）
- **格式选择**: 需要透明度用PNG，否则用JPG

### 2. 性能考虑

- **文件数量**: 建议一次上传不超过20个纹理文件
- **总大小**: 所有纹理文件总大小建议不超过50MB
- **内存管理**: 系统会自动清理不用的纹理URL

### 3. 调试技巧

打开浏览器控制台查看：
- 纹理文件加载日志
- 纹理映射成功/失败信息
- 模型构建详细信息

## 常见问题

### Q: 纹理没有显示，怎么办？

**A: 检查以下几点：**
1. 文件名是否匹配PMX中的引用
2. 纹理文件格式是否支持
3. 查看控制台是否有错误信息
4. 确认模型确实有纹理引用

### Q: 可以只上传部分纹理文件吗？

**A: 可以。** 系统会：
- 应用找到的纹理
- 对未找到纹理的材质使用纯色
- 不会影响模型的正常显示

### Q: 支持动态添加纹理吗？

**A: 支持。** 在模型已加载的情况下：
1. 继续添加纹理文件
2. 系统会自动重新构建模型
3. 新纹理会立即应用

### Q: 纹理文件会上传到服务器吗？

**A: 不会。** 所有处理都在前端进行：
- 纹理文件只在浏览器内存中
- 使用blob:// URL进行本地访问
- 不会发送到任何服务器

## 示例工作流程

### 完整的模型+纹理导入流程

1. **准备文件**
   ```
   model.pmx          (主模型文件)
   face.png          (面部纹理)
   hair.jpg          (头发纹理)
   clothes.bmp       (服装纹理)
   ```

2. **导入操作**
   - 选择 `model.pmx`
   - 在纹理区域选择所有 `.png`, `.jpg`, `.bmp` 文件
   - 点击确定

3. **验证结果**
   - 查看模型显示效果
   - 检查控制台纹理映射日志
   - 确认纹理统计信息

## 技术限制

1. **浏览器内存**: 大量高分辨率纹理可能占用较多内存
2. **文件格式**: 不支持某些特殊格式（如HDR、EXR等）
3. **动画纹理**: 暂不支持动态纹理和视频纹理
4. **法线贴图**: 目前只支持漫反射贴图，不支持法线贴图等高级效果

## 未来功能

- [ ] 法线贴图支持
- [ ] 环境反射贴图
- [ ] 纹理预览功能
- [ ] 批量纹理处理
- [ ] 纹理压缩和优化 