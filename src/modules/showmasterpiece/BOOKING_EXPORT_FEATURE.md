# 预订信息导出CSV功能

## 功能概述
为预订信息管理页面添加了导出预订信息为CSV表格的功能，管理员可以将所有预订数据导出为CSV文件，方便数据分析和备份。

## 实现的功能

### 1. API路由
- **文件**: `src/app/api/showmasterpiece/bookings/admin/export/route.ts`
- **功能**: 导出预订数据为CSV格式
- **方法**: GET
- **参数**: format (查询参数，目前支持 'csv')
- **返回**: CSV文件下载

### 2. 服务层更新
- **文件**: `src/modules/showmasterpiece/services/bookingAdminService.ts`
- **功能**: 
  - 提供`exportBookings`方法
  - 支持CSV格式导出
  - 完善的错误处理

### 3. Hook更新
- **文件**: `src/modules/showmasterpiece/hooks/useBookingAdmin.ts`
- **新增**: `exportBookings`方法
- **功能**: 
  - 调用导出API
  - 自动创建下载链接
  - 错误处理和状态管理

### 4. 组件更新
- **文件**: `src/modules/showmasterpiece/components/BookingAdminPanel.tsx`
- **新增**: 
  - 导出按钮（绿色样式，带下载图标）
  - 导出处理函数
- **更新**: 
  - 更新了组件props接口
  - 在操作栏中添加了导出按钮

### 5. 页面集成
- **文件**: `src/modules/showmasterpiece/pages/config/page.tsx`
- **更新**: 
  - 集成了导出功能到预订管理面板
  - 传递导出回调函数

## 使用方式

### 管理员操作流程
1. 进入配置页面 (`/configManager`)
2. 切换到"预订管理"标签页
3. 点击"导出CSV"按钮（绿色下载图标）
4. 系统自动下载CSV文件
5. 文件名格式：`预订信息_YYYY-MM-DD.csv`

### 导出内容
CSV文件包含以下字段：
- 预订ID
- QQ号
- 手机号
- 画集ID
- 画集标题
- 画集编号
- 画集价格
- 预订状态
- 预订数量
- 用户备注
- 管理员备注
- 创建时间
- 更新时间
- 确认时间
- 完成时间
- 取消时间

## 技术特性

### 1. CSV格式优化
- **中文支持**: 添加BOM标记确保Excel正确识别中文
- **特殊字符处理**: 自动处理包含逗号、引号或换行符的单元格
- **状态映射**: 将英文状态码转换为中文显示
- **时间格式化**: 统一的时间显示格式

### 2. 数据完整性
- **关联查询**: 通过JOIN获取画集信息
- **排序**: 按创建时间排序
- **空值处理**: 优雅处理空值和undefined

### 3. 文件下载
- **自动下载**: 使用Blob和URL.createObjectURL实现
- **文件名**: 包含日期的有意义的文件名
- **内存清理**: 自动清理临时URL对象

## 界面设计

### 导出按钮样式
- 背景色: `bg-green-600`
- 文字色: `text-white`
- 悬停效果: `hover:bg-green-700`
- 图标: `Download` (下载图标)

### 按钮位置
- 位于操作栏右侧
- 与"刷新"按钮并排显示
- 响应式设计，移动端垂直排列

## 数据格式示例

### CSV头部
```csv
预订ID,QQ号,手机号,画集ID,画集标题,画集编号,画集价格,预订状态,预订数量,用户备注,管理员备注,创建时间,更新时间,确认时间,完成时间,取消时间
```

### 数据行示例
```csv
1,123456789,13800138000,1,精美画集,001,99.00,待确认,2,请尽快发货,已联系客户,2024-01-15 10:30:00,2024-01-15 10:30:00,,,
```

## 安全特性

### 1. 权限控制
- 只有管理员可以访问导出功能
- 导出API需要管理员权限

### 2. 数据验证
- 验证导出格式参数
- 检查数据完整性

### 3. 错误处理
- 完善的错误捕获和显示
- 用户友好的错误消息
- 网络错误处理

## 性能优化

### 1. 数据库查询
- 使用LEFT JOIN获取关联数据
- 按创建时间排序优化查询性能
- 只选择必要的字段

### 2. 内存管理
- 流式处理大数据集
- 及时清理临时对象
- 避免内存泄漏

## 注意事项

1. **文件大小**: 大量数据时CSV文件可能较大
2. **浏览器兼容性**: 使用现代浏览器的Blob API
3. **下载限制**: 某些浏览器可能有下载限制
4. **数据实时性**: 导出的是当前数据库中的数据

## 测试建议

1. 测试正常导出流程
2. 测试空数据导出
3. 测试包含特殊字符的数据
4. 测试大量数据的导出性能
5. 测试不同浏览器的兼容性
6. 测试网络错误情况

## 扩展计划

### 未来功能
1. **Excel格式支持**: 添加.xlsx格式导出
2. **筛选导出**: 支持按状态、时间范围筛选导出
3. **批量导出**: 支持选择特定预订导出
4. **定时导出**: 支持定时自动导出功能
5. **邮件发送**: 支持将导出文件通过邮件发送

### 性能优化
1. **分页导出**: 大数据集分页处理
2. **异步导出**: 后台处理，完成后通知
3. **缓存机制**: 缓存常用查询结果 