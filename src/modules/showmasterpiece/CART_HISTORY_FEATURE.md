# 用户购物车历史记录功能

## 功能概述
为用户添加了查看自己购物车历史记录的功能，用户可以通过输入QQ号和手机号查看自己提交过的所有预订信息。所有数据存储在localStorage中，无需用户账号系统。

## 实现的功能

### 1. 数据类型定义
- **文件**: `src/modules/showmasterpiece/types/cart.ts`
- **新增**: 
  - `CartHistoryItem` 接口：历史记录项数据结构
  - `CartHistory` 接口：历史记录集合数据结构
- **功能**: 定义了完整的历史记录数据模型

### 2. 历史记录服务
- **文件**: `src/modules/showmasterpiece/services/cartHistoryService.ts`
- **功能**: 
  - 保存用户提交的购物车数据
  - 获取用户历史记录
  - 更新预订状态
  - 删除历史记录
  - 清空用户所有记录
  - 获取统计数据

### 3. 购物车服务集成
- **文件**: `src/modules/showmasterpiece/services/cartService.ts`
- **更新**: 
  - 在批量预订时自动保存历史记录
  - 传递购物车数据到历史记录服务
- **功能**: 确保每次预订都会保存到历史记录

### 4. Hook更新
- **文件**: `src/modules/showmasterpiece/hooks/useCart.ts`
- **更新**: 
  - 修改`checkoutCart`方法传递购物车数据
- **功能**: 在预订时自动保存历史记录

### 5. 历史记录页面组件
- **文件**: `src/modules/showmasterpiece/components/CartHistoryPage.tsx`
- **功能**: 
  - 显示用户的历史预订记录
  - 支持查看详情、删除记录
  - 统计信息展示
  - 响应式设计

### 6. 用户查询页面
- **文件**: `src/modules/showmasterpiece/pages/history/page.tsx`
- **功能**: 
  - 用户输入QQ号和手机号
  - 表单验证
  - 查询历史记录

### 7. 页面路由
- **文件**: `src/app/(pages)/testField/(utility)/ShowMasterPieces/history/page.tsx`
- **功能**: 提供历史记录页面的路由访问

### 8. 导航集成
- **文件**: `src/modules/showmasterpiece/pages/ShowMasterPiecesPage.tsx`
- **更新**: 
  - 在顶部导航添加历史记录链接
  - 使用History图标
- **功能**: 用户可以方便地访问历史记录页面

## 使用方式

### 用户操作流程
1. **访问历史记录页面**：
   - 在画集展示页面点击"历史记录"按钮
   - 或直接访问 `/testField/ShowMasterPieces/history`

2. **输入查询信息**：
   - 输入QQ号（5-11位数字）
   - 输入手机号（11位手机号）
   - 点击"查询历史记录"

3. **查看历史记录**：
   - 查看所有预订记录列表
   - 点击"查看详情"查看完整信息
   - 点击"删除记录"删除单条记录
   - 点击"清空全部"删除所有记录

### 自动保存机制
- 每次用户提交预订时，系统自动保存购物车数据到历史记录
- 包含完整的商品信息、数量、价格、备注等
- 记录预订状态和预订ID

## 数据存储

### localStorage键名
- `showmasterpiece_cart_history`: 存储所有用户的历史记录

### 数据结构
```typescript
interface CartHistoryItem {
  id: string;                    // 唯一ID
  submittedAt: Date;            // 提交时间
  qqNumber: string;             // QQ号
  phoneNumber: string;          // 手机号
  items: CartItem[];            // 购物车项
  totalQuantity: number;        // 总数量
  totalPrice: number;           // 总价格
  notes?: string;               // 用户备注
  status: 'pending' | 'confirmed' | 'completed' | 'cancelled';
  bookingIds?: number[];        // 预订ID列表
}
```

## 界面设计

### 查询页面
- 简洁的表单设计
- 实时表单验证
- 友好的错误提示
- 查询说明信息

### 历史记录页面
- 统计信息卡片
- 记录列表展示
- 状态标签显示
- 详情弹窗
- 操作按钮

### 导航集成
- 历史记录图标按钮
- 响应式设计
- 悬停效果

## 功能特性

### 1. 数据完整性
- 保存完整的购物车信息
- 包含商品详情、价格、数量
- 记录用户备注和预订状态

### 2. 用户友好
- 无需注册账号
- 简单的QQ号+手机号查询
- 直观的界面设计

### 3. 数据管理
- 支持删除单条记录
- 支持清空所有记录
- 按时间倒序排列

### 4. 状态管理
- 预订状态跟踪
- 状态颜色标识
- 预订ID关联

### 5. 统计功能
- 总预订次数
- 总预订数量
- 总预订金额
- 已完成数量

## 安全特性

### 1. 数据隔离
- 每个用户只能查看自己的记录
- 通过QQ号+手机号组合识别用户

### 2. 数据验证
- 表单输入验证
- 数据格式检查
- 错误处理机制

### 3. 本地存储
- 数据存储在用户本地
- 无需服务器存储敏感信息
- 用户完全控制数据

## 技术实现

### 1. 服务层设计
- 完整的CRUD操作
- 错误处理和日志记录
- 数据序列化和反序列化

### 2. 组件架构
- 可复用的历史记录组件
- 独立的查询页面
- 模块化的设计

### 3. 状态管理
- React Hook管理状态
- 异步操作处理
- 错误状态管理

### 4. 用户体验
- 加载状态显示
- 错误信息提示
- 操作确认对话框

## 扩展计划

### 未来功能
1. **数据导出**: 支持导出历史记录为CSV
2. **搜索过滤**: 按时间、状态、商品搜索
3. **数据同步**: 支持云端备份和同步
4. **通知功能**: 预订状态变更通知
5. **数据分析**: 用户消费行为分析

### 性能优化
1. **分页加载**: 大量数据分页显示
2. **数据压缩**: 优化localStorage使用
3. **缓存机制**: 提高查询性能
4. **懒加载**: 优化页面加载速度

## 测试建议

1. **功能测试**:
   - 测试查询功能
   - 测试记录保存
   - 测试删除功能
   - 测试状态更新

2. **数据测试**:
   - 测试大量数据性能
   - 测试数据完整性
   - 测试数据恢复

3. **用户体验测试**:
   - 测试响应式设计
   - 测试错误处理
   - 测试操作流程

4. **兼容性测试**:
   - 测试不同浏览器
   - 测试移动端体验
   - 测试localStorage限制 