# MMD 压缩包上传功能指南

## 📦 功能概述

MMD 压缩包上传功能允许你将整个 MMD 资源包（包含模型、贴图、动作、音频等）打包成 `.zip` 压缩包，一键上传到 OSS，自动解压并规范化文件名和目录结构。

## ✨ 功能特点

### 1. **自动解压**
- 服务端自动解压 `.zip` 压缩包
- 无需手动解压，节省时间

### 2. **保持结构**
- 自动保持文件夹结构和相对路径
- 确保模型能正确引用贴图文件

### 3. **规范命名**
- 自动规范化目录和文件名
- 移除特殊字符和中文空格
- 统一转换为小写

### 4. **一键上传**
- 无需手动选择文件夹
- 拖拽或点击即可上传
- 支持自定义模型名称

### 5. **完整性保证**
- 自动识别模型、贴图、动作、音频文件
- 确保所有资源一并上传
- 提供详细的上传统计

### 6. **智能分类**
- 自动分类文件类型（模型、贴图、动作、音频）
- 生成完整的资源路径
- 提供即用的代码示例

## 🚀 使用方法

### 步骤 1：准备 MMD 资源

确保你的 MMD 资源文件夹结构如下：

```
miku/
├── miku.pmx                 # 模型文件
├── textures/                # 贴图文件夹
│   ├── face.png
│   ├── body.png
│   ├── hair.png
│   └── ...
├── motions/                 # 动作文件夹（可选）
│   ├── dance.vmd
│   └── ...
└── audio/                   # 音频文件夹（可选）
    ├── song.wav
    └── ...
```

### 步骤 2：压缩为 .zip 格式

**Windows:**
```
右键点击 miku 文件夹 → 发送到 → 压缩(zipped)文件夹
```

**macOS:**
```
右键点击 miku 文件夹 → 压缩 "miku"
```

**Linux:**
```bash
zip -r miku.zip miku/
```

### 步骤 3：上传压缩包

1. 访问 `/testField/mmdUpload` 页面
2. 选择 **"📦 压缩包上传（推荐）"** 模式
3. 拖拽 `miku.zip` 到上传区域，或点击选择文件
4. 输入模型名称（可选，留空使用原始名称）
5. 等待自动解压和上传完成

### 步骤 4：获取资源路径

上传成功后，页面会显示：

- ✅ **模型路径**：完整的 OSS URL
- 🎬 **动作路径**：所有动作文件的 OSS URL
- 🎵 **音频路径**：所有音频文件的 OSS URL
- 📋 **代码示例**：即用的配置代码

### 步骤 5：在代码中使用

复制生成的代码示例，直接使用：

```typescript
const resources = {
  modelPath: 'https://your-oss.com/mmd/2025/11/23/miku/miku.pmx',
  motionPath: 'https://your-oss.com/mmd/2025/11/23/miku/motions/dance.vmd',
  audioPath: 'https://your-oss.com/mmd/2025/11/23/miku/audio/song.wav',
};
```

## 📋 技术细节

### 支持的文件类型

| 类型 | 扩展名 | 说明 |
|------|--------|------|
| **模型** | `.pmx`, `.pmd` | MMD 模型文件 |
| **动作** | `.vmd` | VMD 动作文件 |
| **音频** | `.wav`, `.mp3`, `.ogg`, `.m4a` | 音频文件 |
| **贴图** | `.png`, `.jpg`, `.jpeg`, `.bmp`, `.tga`, `.spa`, `.sph` | 贴图文件 |

### 文件名规范化规则

1. **中文和空格** → 转换为连字符 `-`
2. **特殊字符** → 移除
3. **大写字母** → 转换为小写

**示例：**
```
原始: "初音 Miku (Ver.2.0).pmx"
规范化: "miku-ver-2-0.pmx"
```

### 目录结构

上传后的文件会保持原始结构：

```
OSS 路径: mmd/{year}/{month}/{day}/{modelName}/
例如: mmd/2025/11/23/miku/
├── miku.pmx
├── textures/
│   ├── face.png
│   └── ...
├── motions/
│   └── dance.vmd
└── audio/
    └── song.wav
```

### API 端点

**端点:** `/api/upload-mmd-zip`

**方法:** `POST`

**请求参数:**
- `file`: `.zip` 压缩包文件（必需）
- `modelName`: 自定义模型名称（可选）

**响应格式:**
```json
{
  "success": true,
  "modelName": "miku",
  "basePath": "mmd/2025/11/23/miku",
  "ossBaseUrl": "https://your-oss.com",
  "files": [
    {
      "originalPath": "miku.pmx",
      "storagePath": "mmd/2025/11/23/miku/miku.pmx",
      "cdnUrl": "https://your-oss.com/mmd/2025/11/23/miku/miku.pmx",
      "type": "model",
      "size": 1234567
    }
  ],
  "summary": {
    "total": 10,
    "uploaded": 10,
    "failed": 0
  },
  "resources": {
    "modelPath": "https://your-oss.com/mmd/2025/11/23/miku/miku.pmx",
    "motionPaths": ["https://your-oss.com/mmd/2025/11/23/miku/motions/dance.vmd"],
    "audioPaths": ["https://your-oss.com/mmd/2025/11/23/miku/audio/song.wav"]
  },
  "usage": {
    "example": "// 代码示例..."
  }
}
```

## 🆚 压缩包 vs 文件夹上传

| 特性 | 压缩包上传 | 文件夹上传 |
|------|-----------|-----------|
| **便捷性** | ⭐⭐⭐⭐⭐ 一键上传 | ⭐⭐⭐ 需要选择文件夹 |
| **规范化** | ⭐⭐⭐⭐⭐ 自动规范化 | ⭐⭐ 保持原始名称 |
| **完整性** | ⭐⭐⭐⭐⭐ 保证完整 | ⭐⭐⭐⭐ 依赖用户选择 |
| **速度** | ⭐⭐⭐⭐ 批量上传 | ⭐⭐⭐ 逐个上传 |
| **代码示例** | ⭐⭐⭐⭐⭐ 自动生成 | ⭐⭐ 需要手动拼接 |
| **推荐场景** | 生产环境、批量上传 | 开发测试、单个文件 |

## ⚠️ 注意事项

### 1. 文件大小限制
- 单个压缩包最大 **500MB**
- 如果超过限制，请分批上传

### 2. 压缩包结构
- 确保压缩包内包含完整的文件夹结构
- 不要只压缩单个 `.pmx` 文件
- 贴图文件必须在正确的相对路径下

### 3. 文件命名
- 避免使用特殊字符和中文空格
- 推荐使用英文和数字
- 系统会自动规范化，但最好提前处理

### 4. CORS 配置
- 确保 OSS 已配置 CORS 规则
- 参考 `docs/oss-cors-setup.md`

### 5. 网络超时
- 大文件上传可能需要较长时间
- API 超时设置为 5 分钟
- 如果超时，请尝试分批上传

## 🐛 故障排查

### 问题 1：上传失败 - "压缩包中没有找到 MMD 模型文件"

**原因：** 压缩包内没有 `.pmx` 或 `.pmd` 文件

**解决方法：**
1. 检查压缩包内容
2. 确保包含模型文件
3. 重新压缩并上传

### 问题 2：模型加载不出来 - 贴图丢失

**原因：** 贴图文件没有一起上传，或路径不正确

**解决方法：**
1. 确保压缩包包含所有贴图文件
2. 保持原始文件夹结构
3. 检查 OSS 上的文件列表

### 问题 3：上传超时

**原因：** 压缩包过大或网络不稳定

**解决方法：**
1. 检查压缩包大小（最大 500MB）
2. 尝试压缩贴图文件（降低分辨率）
3. 使用稳定的网络连接
4. 考虑分批上传

### 问题 4：文件名乱码

**原因：** 压缩包使用了非 UTF-8 编码

**解决方法：**
1. 使用支持 UTF-8 的压缩工具
2. 提前规范化文件名
3. 系统会自动处理大部分情况

### 问题 5：CORS 错误

**原因：** OSS 未配置 CORS 规则

**解决方法：**
1. 参考 `docs/oss-cors-setup.md` 配置 CORS
2. 确保允许的域名包含你的应用域名
3. 检查 OSS 控制台的 CORS 设置

## 💡 最佳实践

### 1. 压缩包命名
```
✅ 推荐: miku-v2.zip, hatsune-miku-2024.zip
❌ 避免: 初音 Miku (Ver.2.0).zip, model@#$.zip
```

### 2. 文件夹结构
```
✅ 推荐:
miku/
├── miku.pmx
└── textures/
    └── ...

❌ 避免:
miku.pmx (单个文件，没有文件夹)
```

### 3. 贴图优化
- 使用 `.png` 或 `.jpg` 格式
- 适当压缩贴图大小（1024x1024 或 2048x2048）
- 移除不必要的贴图文件

### 4. 批量上传
- 将多个模型分别压缩
- 逐个上传，避免混淆
- 使用有意义的模型名称

### 5. 版本管理
- 在模型名称中包含版本号
- 例如：`miku-v1`, `miku-v2`
- 便于后续更新和维护

## 📚 相关文档

- [MMD 资源上传指南](./mmd-resource-upload-guide.md)
- [OSS CORS 配置指南](./oss-cors-setup.md)
- [OSS 路径配置指南](./mmd-oss-path-guide.md)
- [MMD 播放器组件文档](./mmd-player-enhanced.md)

## 🎯 总结

压缩包上传功能是最推荐的 MMD 资源上传方式，它提供了：

✅ **便捷性** - 一键上传，无需手动选择文件  
✅ **完整性** - 保证所有资源一并上传  
✅ **规范性** - 自动规范化文件名和路径  
✅ **可靠性** - 服务端处理，更加稳定  
✅ **易用性** - 自动生成代码示例，即用即走  

**推荐在生产环境中使用压缩包上传功能！** 🚀

