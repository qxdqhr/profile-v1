# MMD æ’­æ”¾åˆ—è¡¨ç»„ä»¶ (MMDPlaylist)

## æ¦‚è¿°

`MMDPlaylist` æ˜¯åŸºäº `MMDPlayerEnhanced` å°è£…çš„æ’­æ”¾åˆ—è¡¨ç»„ä»¶ï¼Œæ”¯æŒå¤šä¸ª MMD èµ„æºé…ç½®çš„è¿ç»­æ’­æ”¾ã€‚

## æ ¸å¿ƒç‰¹æ€§

- âœ… **èµ„æºé¢„åŠ è½½**ï¼šåœ¨åˆå§‹åŒ–æ—¶é¢„åŠ è½½æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æº
- âœ… **æ— ç¼åˆ‡æ¢**ï¼šåˆ‡æ¢èŠ‚ç‚¹æ—¶æ— éœ€åŠ è½½é¡µé¢ï¼Œç¬æ—¶å®Œæˆ
- âœ… æ”¯æŒå¤šä¸ªèµ„æºèŠ‚ç‚¹çš„è¿ç»­æ’­æ”¾
- âœ… æ”¯æŒæ’­æ”¾åˆ—è¡¨å¾ªç¯
- âœ… æ”¯æŒå•èŠ‚ç‚¹å¾ªç¯
- âœ… æä¾›ä¸Šä¸€ä¸ª/ä¸‹ä¸€ä¸ªèŠ‚ç‚¹åˆ‡æ¢æŒ‰é’®
- âœ… æä¾›æ’­æ”¾åˆ—è¡¨å¼¹çª—ï¼Œæ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹å¹¶æ”¯æŒè·³è½¬
- âœ… åœ¨å·¦ä¸Šè§’æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹ä¿¡æ¯
- âœ… æ’­æ”¾åˆ—è¡¨æŒ‰é’®ä½äºå³ä¸‹è§’ï¼Œä¸ä¸æ’­æ”¾å™¨æ§åˆ¶æŒ‰é’®é‡å 
- âœ… è‡ªåŠ¨å¤„ç†èŠ‚ç‚¹åˆ‡æ¢å’Œæ’­æ”¾çŠ¶æ€
- âœ… å®Œå…¨ç‹¬ç«‹çš„ç»„ä»¶ï¼Œä¸å½±å“ `MMDPlayerEnhanced` çš„åŸæœ‰é€»è¾‘

## é¢„åŠ è½½æœºåˆ¶

### å·¥ä½œåŸç†

1. **å¹¶è¡ŒåŠ è½½**ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºç‹¬ç«‹çš„ `MMDPlayerEnhanced` å®ä¾‹
2. **éšè—æ¸²æŸ“**ï¼šæ‰€æœ‰èŠ‚ç‚¹åŒæ—¶åŠ è½½ï¼Œä½†åªæœ‰å½“å‰èŠ‚ç‚¹å¯è§
3. **çŠ¶æ€è·Ÿè¸ª**ï¼šè·Ÿè¸ªæ¯ä¸ªèŠ‚ç‚¹çš„åŠ è½½çŠ¶æ€ï¼Œå…¨éƒ¨å®Œæˆåéšè—åŠ è½½é¡µé¢
4. **ç¬æ—¶åˆ‡æ¢**ï¼šåˆ‡æ¢èŠ‚ç‚¹åªéœ€æ”¹å˜ `visibility` å±æ€§ï¼Œæ— éœ€é‡æ–°åŠ è½½

### ä¼˜åŠ¿

- ğŸš€ **èŠ‚ç‚¹åˆ‡æ¢ç¬æ—¶å®Œæˆ**ï¼Œæ— åŠ è½½ç­‰å¾…
- ğŸ’¾ **èµ„æºåªåŠ è½½ä¸€æ¬¡**ï¼Œå†…å­˜ä¸­ä¿æŒ
- ğŸ¯ **ç”¨æˆ·ä½“éªŒæµç•…**ï¼Œæ— ä¸­æ–­æ„Ÿ

### æ³¨æ„äº‹é¡¹

- âš ï¸ **å†…å­˜å ç”¨å¢åŠ **ï¼šæ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å­˜åœ¨äºå†…å­˜ä¸­
- âš ï¸ **é€‚åˆåœºæ™¯**ï¼šå»ºè®®èŠ‚ç‚¹æ•°é‡ < 10 ä¸ª
- âš ï¸ **åˆå§‹åŠ è½½æ—¶é—´**ï¼šç¬¬ä¸€æ¬¡åŠ è½½æ‰€æœ‰èµ„æºéœ€è¦è¾ƒé•¿æ—¶é—´

## ç±»å‹å®šä¹‰

### MMDPlaylistNode

```typescript
interface MMDPlaylistNode {
  /** èŠ‚ç‚¹ ID */
  id: string;
  /** èŠ‚ç‚¹åç§° */
  name: string;
  /** èŠ‚ç‚¹æè¿°ï¼ˆå¯é€‰ï¼‰ */
  description?: string;
  /** èµ„æºé…ç½® */
  resources: MMDResources;
  /** æ˜¯å¦å¾ªç¯æ’­æ”¾å½“å‰èŠ‚ç‚¹ï¼ˆé»˜è®¤ falseï¼‰ */
  loop?: boolean;
}
```

### MMDPlaylistConfig

```typescript
interface MMDPlaylistConfig {
  /** æ’­æ”¾åˆ—è¡¨ ID */
  id: string;
  /** æ’­æ”¾åˆ—è¡¨åç§° */
  name: string;
  /** æ’­æ”¾åˆ—è¡¨æè¿°ï¼ˆå¯é€‰ï¼‰ */
  description?: string;
  /** æ’­æ”¾èŠ‚ç‚¹åˆ—è¡¨ */
  nodes: MMDPlaylistNode[];
  /** æ˜¯å¦å¾ªç¯æ’­æ”¾æ•´ä¸ªåˆ—è¡¨ï¼ˆé»˜è®¤ falseï¼‰ */
  loop?: boolean;
  /** æ˜¯å¦è‡ªåŠ¨æ’­æ”¾ï¼ˆé»˜è®¤ trueï¼‰ */
  autoPlay?: boolean;
}
```

### MMDPlaylistProps

```typescript
interface MMDPlaylistProps {
  /** æ’­æ”¾åˆ—è¡¨é…ç½® */
  playlist: MMDPlaylistConfig;
  /** èˆå°é…ç½® */
  stage?: MMDStage;
  /** é»˜è®¤æ’­æ”¾çš„èŠ‚ç‚¹ç´¢å¼•ï¼ˆé»˜è®¤ 0ï¼‰ */
  defaultNodeIndex?: number;
  /** è‡ªå®šä¹‰æ ·å¼ç±»å */
  className?: string;
  /** è‡ªå®šä¹‰æ ·å¼ */
  style?: React.CSSProperties;
  /** èµ„æºåŠ è½½å®Œæˆå›è°ƒ */
  onLoad?: () => void;
  /** èµ„æºåŠ è½½é”™è¯¯å›è°ƒ */
  onError?: (error: any) => void;
  /** èŠ‚ç‚¹åˆ‡æ¢å›è°ƒ */
  onNodeChange?: (nodeIndex: number, node: MMDPlaylistNode) => void;
  /** æ’­æ”¾åˆ—è¡¨å®Œæˆå›è°ƒ */
  onPlaylistComplete?: () => void;
}
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

```tsx
import { MMDPlaylist, type MMDPlaylistConfig } from 'sa2kit/mmd';

const playlist: MMDPlaylistConfig = {
  id: 'my-playlist',
  name: 'æˆ‘çš„æ’­æ”¾åˆ—è¡¨',
  description: 'åŒ…å«å¤šä¸ª MMD è¡¨æ¼”çš„è¿ç»­æ’­æ”¾',
  nodes: [
    {
      id: 'node1',
      name: 'åˆéŸ³æœªæ¥ - Catch The Wave',
      resources: {
        modelPath: '/models/miku.pmx',
        motionPath: '/motions/catch-the-wave.vmd',
        audioPath: '/audio/catch-the-wave.wav',
        cameraPath: '/camera/catch-the-wave.vmd',
      },
      loop: false,
    },
    {
      id: 'node2',
      name: 'è‰¾å°”è - æ‰“æ‹›å‘¼',
      resources: {
        modelPath: '/models/elsa.pmx',
        motionPath: '/motions/greeting.vmd',
      },
      loop: false,
    },
  ],
  loop: true, // æ’­æ”¾åˆ—è¡¨å¾ªç¯
  autoPlay: true, // è‡ªåŠ¨æ’­æ”¾
};

export default function MyPage() {
  return (
    <div className="h-screen w-screen">
      <MMDPlaylist
        playlist={playlist}
        onNodeChange={(index, node) => {
          console.log('èŠ‚ç‚¹åˆ‡æ¢:', index, node.name);
        }}
        onPlaylistComplete={() => {
          console.log('æ’­æ”¾åˆ—è¡¨å®Œæˆ');
        }}
      />
    </div>
  );
}
```

### å®Œæ•´é…ç½®ç¤ºä¾‹

```tsx
const playlist: MMDPlaylistConfig = {
  id: 'full-playlist',
  name: 'å®Œæ•´æ’­æ”¾åˆ—è¡¨',
  description: 'åŒ…å«åœºæ™¯å’ŒèƒŒæ™¯çš„å®Œæ•´è¡¨æ¼”',
  nodes: [
    {
      id: 'node1',
      name: 'èŠ‚ç‚¹ 1',
      description: 'å¸¦åœºæ™¯å’ŒèƒŒæ™¯çš„è¡¨æ¼”',
      resources: {
        modelPath: '/models/miku.pmx',
        motionPath: '/motions/dance.vmd',
        audioPath: '/audio/music.wav',
        cameraPath: '/camera/camera.vmd',
        stageModelPath: '/stages/classroom.pmx', // åœºæ™¯æ¨¡å‹
        backgroundPath: '/backgrounds/sky.jpg', // èƒŒæ™¯å›¾ç‰‡
      },
      loop: false,
    },
    {
      id: 'node2',
      name: 'èŠ‚ç‚¹ 2',
      description: 'å¾ªç¯æ’­æ”¾çš„èŠ‚ç‚¹',
      resources: {
        modelPath: '/models/elsa.pmx',
        motionPath: '/motions/idle.vmd',
      },
      loop: true, // è¿™ä¸ªèŠ‚ç‚¹ä¼šå¾ªç¯æ’­æ”¾ï¼Œä¸ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
    },
  ],
  loop: true,
  autoPlay: true,
};

const customStage = {
  backgroundColor: '#01030b',
  cameraPosition: { x: 0, y: 10, z: 30 },
  cameraTarget: { x: 0, y: 10, z: 0 },
  enablePhysics: true,
  showGrid: false,
  ammoPath: '/libs/ammo.wasm.js',
  ammoWasmPath: '/libs/',
  backgroundType: 'image' as const,
};

<MMDPlaylist
  playlist={playlist}
  stage={customStage}
  defaultNodeIndex={0}
  className="h-full w-full"
  onNodeChange={(index, node) => console.log('èŠ‚ç‚¹åˆ‡æ¢:', index, node.name)}
  onPlaylistComplete={() => console.log('æ’­æ”¾åˆ—è¡¨å®Œæˆ')}
/>
```

## æ’­æ”¾é€»è¾‘

### è‡ªåŠ¨åˆ‡æ¢

- **æœ‰éŸ³é¢‘çš„èŠ‚ç‚¹**ï¼šéŸ³é¢‘æ’­æ”¾å®Œæˆåï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- **æ²¡æœ‰éŸ³é¢‘çš„èŠ‚ç‚¹**ï¼šåŠ¨ç”»æ’­æ”¾å®Œæˆåï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
- å¦‚æœå½“å‰èŠ‚ç‚¹è®¾ç½®äº† `loop: true`ï¼Œåˆ™ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢
- å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸”æ’­æ”¾åˆ—è¡¨è®¾ç½®äº† `loop: true`ï¼Œåˆ™å›åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
- å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸”æ’­æ”¾åˆ—è¡¨æ²¡æœ‰è®¾ç½®å¾ªç¯ï¼Œåˆ™è§¦å‘ `onPlaylistComplete` å›è°ƒ

### åŠ¨ç”»ç»“æŸæ£€æµ‹

- ç»„ä»¶ä¼šè‡ªåŠ¨æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦æœ‰éŸ³é¢‘
- **æœ‰éŸ³é¢‘**ï¼šä½¿ç”¨ `onAudioEnded` å›è°ƒï¼Œåœ¨éŸ³é¢‘ç»“æŸæ—¶è§¦å‘
- **æ²¡æœ‰éŸ³é¢‘**ï¼šä½¿ç”¨ `onAnimationEnded` å›è°ƒï¼Œåœ¨åŠ¨ç”»ç»“æŸæ—¶è§¦å‘
- åŠ¨ç”»ç»“æŸåˆ¤å®šï¼šå½“å‰æ’­æ”¾æ—¶é—´ >= åŠ¨ç”»æ—¶é•¿ - 0.1ç§’ï¼ˆç•™ä¸€ç‚¹ä½™é‡é¿å…æµ®ç‚¹æ•°è¯¯å·®ï¼‰
- åŠ¨ç”»æ—¶é•¿ä» VMD æ–‡ä»¶ä¸­è‡ªåŠ¨è¯»å–

### æ‰‹åŠ¨åˆ‡æ¢

- ç‚¹å‡»"ä¸Šä¸€ä¸ª"æŒ‰é’®ï¼šåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è·³åˆ°æœ€åä¸€ä¸ªï¼‰
- ç‚¹å‡»"ä¸‹ä¸€ä¸ª"æŒ‰é’®ï¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆå¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è·³åˆ°ç¬¬ä¸€ä¸ªï¼‰
- ç‚¹å‡»"æ’­æ”¾åˆ—è¡¨"æŒ‰é’®ï¼šæ‰“å¼€æ’­æ”¾åˆ—è¡¨å¼¹çª—ï¼Œç‚¹å‡»ä»»æ„èŠ‚ç‚¹è·³è½¬

### è‡ªåŠ¨æ’­æ”¾

- ç¬¬ä¸€æ¬¡åŠ è½½æ—¶ï¼Œå¦‚æœ `playlist.autoPlay !== false`ï¼Œåˆ™è‡ªåŠ¨æ’­æ”¾
- è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œä¼šè‡ªåŠ¨å¼€å§‹æ’­æ”¾
- æ‰‹åŠ¨åˆ‡æ¢èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨ç‚¹å‡»æ’­æ”¾æŒ‰é’®

## UI å¸ƒå±€

- **å·¦ä¸Šè§’**ï¼šå½“å‰èŠ‚ç‚¹ä¿¡æ¯ï¼ˆèŠ‚ç‚¹ç¼–å·ã€èŠ‚ç‚¹åç§°ã€å¾ªç¯æ ‡è®°ï¼‰
- **åº•éƒ¨ä¸­å¤®**ï¼šæ’­æ”¾å™¨æ§åˆ¶æŒ‰é’®ï¼ˆæ’­æ”¾/æš‚åœã€åœæ­¢ï¼‰- ç”± `MMDPlayerEnhanced` æä¾›
- **å³ä¸Šè§’**ï¼šè®¾ç½®æŒ‰é’®ï¼ˆå¦‚æœä½¿ç”¨ `resourceOptions` æ¨¡å¼ï¼‰- ç”± `MMDPlayerEnhanced` æä¾›
- **å³ä¸‹è§’**ï¼šæ’­æ”¾åˆ—è¡¨æ§åˆ¶æŒ‰é’®ï¼ˆä¸Šä¸€ä¸ªã€æ’­æ”¾åˆ—è¡¨ã€ä¸‹ä¸€ä¸ªï¼‰

## æ³¨æ„äº‹é¡¹

1. **èµ„æºé¢„åŠ è½½**ï¼š
   - åˆå§‹åŒ–æ—¶ä¼šé¢„åŠ è½½æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æº
   - æ˜¾ç¤ºé¢„åŠ è½½è¿›åº¦æ¡å’Œå·²åŠ è½½èŠ‚ç‚¹æ•°
   - å…¨éƒ¨èŠ‚ç‚¹åŠ è½½å®Œæˆåæ‰èƒ½å¼€å§‹æ’­æ”¾å’Œåˆ‡æ¢
   
2. **å†…å­˜ç®¡ç†**ï¼š
   - æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºåŒæ—¶å­˜åœ¨äºå†…å­˜ä¸­
   - å»ºè®®èŠ‚ç‚¹æ•°é‡æ§åˆ¶åœ¨ 10 ä¸ªä»¥å†…
   - æ¯ä¸ªèŠ‚ç‚¹åŒ…å«å®Œæ•´çš„ Three.js åœºæ™¯å’Œæ¨¡å‹
   
3. **åˆ‡æ¢æ€§èƒ½**ï¼š
   - èŠ‚ç‚¹åˆ‡æ¢ç¬æ—¶å®Œæˆï¼Œæ— éœ€ç­‰å¾…åŠ è½½
   - ä½¿ç”¨ `visibility` å±æ€§æ§åˆ¶æ˜¾ç¤ºï¼Œä¸é”€æ¯å®ä¾‹
   - é€‚åˆéœ€è¦é¢‘ç¹åˆ‡æ¢çš„åœºæ™¯
   
4. **è‡ªåŠ¨åˆ‡æ¢æ”¯æŒ**ï¼š
   - **æœ‰éŸ³é¢‘çš„èŠ‚ç‚¹**ï¼šä½¿ç”¨ `onAudioEnded` å›è°ƒï¼Œåœ¨éŸ³é¢‘ç»“æŸæ—¶è‡ªåŠ¨åˆ‡æ¢
   - **æ²¡æœ‰éŸ³é¢‘çš„èŠ‚ç‚¹**ï¼šä½¿ç”¨ `onAnimationEnded` å›è°ƒï¼Œåœ¨åŠ¨ç”»ç»“æŸæ—¶è‡ªåŠ¨åˆ‡æ¢
   - ä¸¤ç§æ–¹å¼éƒ½èƒ½æ­£ç¡®å®ç°è‡ªåŠ¨èŠ‚ç‚¹åˆ‡æ¢
   
5. **å¾ªç¯æ’­æ”¾**ï¼š
   - èŠ‚ç‚¹çš„ `loop` ä¼˜å…ˆçº§é«˜äºæ’­æ”¾åˆ—è¡¨çš„ `loop`
   - å¦‚æœèŠ‚ç‚¹è®¾ç½®äº†å¾ªç¯ï¼Œåˆ™ä¸ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
   
6. **åŠ¨ç”»æ—¶é•¿**ï¼š
   - åŠ¨ç”»æ—¶é•¿ä» VMD æ–‡ä»¶ä¸­è‡ªåŠ¨è¯»å–
   - å¦‚æœ VMD æ–‡ä»¶æ²¡æœ‰æä¾›æ—¶é•¿ä¿¡æ¯ï¼Œä½¿ç”¨åœæ­¢æ£€æµ‹æ–¹æ¡ˆ
   
7. **é€‚ç”¨åœºæ™¯**ï¼š
   - âœ… é€‚åˆï¼šèŠ‚ç‚¹æ•°é‡å°‘ã€éœ€è¦é¢‘ç¹åˆ‡æ¢ã€è¿½æ±‚æµç•…ä½“éªŒ
   - âŒ ä¸é€‚åˆï¼šèŠ‚ç‚¹æ•°é‡å¤šï¼ˆ>10ï¼‰ã€å†…å­˜å—é™çš„è®¾å¤‡

## æµ‹è¯•é¡µé¢

æµ‹è¯•é¡µé¢è·¯å¾„ï¼š`/testField/mmdPlaylistTest`

åŒ…å« 3 ä¸ªæµ‹è¯•èŠ‚ç‚¹ï¼š
1. åˆéŸ³æœªæ¥ - Catch The Waveï¼ˆå®Œæ•´è¡¨æ¼”ï¼‰
2. è‰¾å°”è - æ‰“æ‹›å‘¼ï¼ˆç®€å•åŠ¨ä½œï¼‰
3. åˆéŸ³æœªæ¥ + åœºæ™¯ + èƒŒæ™¯ï¼ˆå®Œæ•´é…ç½®ï¼‰

## ä¸ MMDPlayerEnhanced çš„å…³ç³»

- `MMDPlaylist` æ˜¯åŸºäº `MMDPlayerEnhanced` å°è£…çš„é«˜çº§ç»„ä»¶
- ä¸å½±å“ `MMDPlayerEnhanced` çš„åŸæœ‰é€»è¾‘å’ŒåŠŸèƒ½
- å¯ä»¥å•ç‹¬ä½¿ç”¨ `MMDPlayerEnhanced` æˆ– `MMDPlaylist`
- `MMDPlaylist` å†…éƒ¨ä½¿ç”¨ `MMDPlayerEnhanced` çš„ `resources` æ¨¡å¼ï¼ˆå•èµ„æºæ¨¡å¼ï¼‰

